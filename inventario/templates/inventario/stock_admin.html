{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="logo-fullscreen mb-5">
    <img src="{% static 'images/logo.jpg' %}" alt="Logo de la empresa" class="img-fluid w-100" style="height: auto;">
</div>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-5">Gestión de Inventario</h1>
            <p class="lead">Bienvenido, {{ user.username }}</p>
        </div>
        <div class="col-auto d-flex align-items-center">
            <!-- Botón Nuevo Producto -->
            <button class="btn btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#agregarProductoModal">
                <i class="bi bi-plus-circle"></i> Nuevo Producto
            </button>
            <!-- Botón Mermas -->
            <a href="{% url 'inventario:mermas_publico' %}" class="btn btn-primary ms-2">
                <i class="bi bi-clipboard-data"></i> Registros de Mermas
            </a>
        </div>
    </div>

    <!-- Barra de búsqueda -->
    <div class="row mb-3">
        <div class="col">
            <div class="input-group" style="max-width: 300px;">
                <input type="text" id="searchInput" class="form-control" placeholder="Buscar productos..." aria-label="Buscar productos">
                <button class="btn btn-outline-secondary" type="button" id="searchButton">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="row" id="productList">
        {% for producto in productos %}
        <div class="col-xl-3 col-lg-4 col-md-6 mb-4" data-nombre="{{ producto.nombre|lower }}">
            <div class="card h-100 shadow-sm position-relative">
                <button class="btn btn-sm btn-danger btn-eliminar position-absolute top-0 end-0 m-2 rounded-circle" 
                        data-id="{{ producto.id }}"
                        style="width: 30px; height: 30px; padding: 0;">
                    <i class="bi bi-trash"></i>
                </button>
                
                <div class="card-body">
                    <h5 class="card-title">{{ producto.nombre }}</h5>
                    <p class="card-text mb-3">
                        <strong>Stock:</strong> <span class="stock-value">{{ producto.cantidad }}</span> {{ producto.get_unidad_display }}
                    </p>
                    
                    <div class="d-flex justify-content-between gap-2">
                        <!-- Botón Agregar -->
                        <button class="btn btn-sm btn-success btn-agregar flex-grow-1"
                                data-id="{{ producto.id }}"
                                data-nombre="{{ producto.nombre }}"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Agregar stock">
                            <i class="bi bi-plus-circle"></i> <span class="d-none d-md-inline">Agregar</span>
                        </button>
                        
                        <!-- Botón Quitar -->
                        <button class="btn btn-sm btn-danger btn-quitar flex-grow-1"
                                data-id="{{ producto.id }}"
                                data-nombre="{{ producto.nombre }}"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Quitar stock">
                            <i class="bi bi-dash-circle"></i> <span class="d-none d-md-inline">Quitar</span>
                        </button>
                        
                        <!-- Botón Merma -->
                        <button class="btn btn-sm btn-warning btn-merma flex-grow-1"
                                data-id="{{ producto.id }}"
                                data-nombre="{{ producto.nombre }}"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Registrar merma">
                            <i class="bi bi-clipboard-minus"></i> <span class="d-none d-md-inline">Merma</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info">No hay productos registrados</div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal Agregar Producto -->
<div class="modal fade" id="agregarProductoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Agregar Nuevo Producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="formAgregarProducto" method="post" novalidate>
        {% csrf_token %}
        <input type="hidden" name="operation" value="create">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nombre del Producto</label>
            <input type="text" class="form-control" name="nombre" required>
             <div class="invalid-feedback" id="nombreProductoFeedback">
            Por favor ingrese un nombre válido
        </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Cantidad</label>
              <input type="number" step="1" min="0" class="form-control" name="cantidad" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Unidad</label>
              <select class="form-select" name="unidad" required>
                {% for value, label in unidades.items %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div id="formAgregarProductoError" class="alert alert-danger d-none"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Producto</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Merma -->
<div class="modal fade" id="mermaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title">Registrar Merma</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="formMerma" method="post">
        {% csrf_token %}
        <input type="hidden" name="operation" value="merma">
        <input type="hidden" name="producto_id" id="mermaProductoId">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Producto</label>
            <input type="text" class="form-control" id="mermaProductoNombre" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Stock Actual</label>
            <input type="text" class="form-control" id="mermaStockActual" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Cantidad a Descontar</label>
            <input type="number" step="1" min="1" class="form-control" name="cantidad" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Motivo</label>
            <textarea class="form-control" name="motivo" rows="3" required></textarea>
          </div>
          <div id="mermaError" class="alert alert-danger d-none"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-warning">Registrar Merma</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Agregar Stock -->
<div class="modal fade" id="agregarStockModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Agregar Stock</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="formAgregarStock" method="post">
        {% csrf_token %}
        <input type="hidden" name="operation" value="agregar_stock">
        <input type="hidden" name="producto_id" id="agregarStockProductoId">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Producto</label>
            <input type="text" class="form-control" id="agregarStockProductoNombre" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Stock Actual</label>
            <input type="text" class="form-control" id="agregarStockActual" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Cantidad a Agregar</label>
            <input type="number" step="1" min="1" class="form-control" name="cantidad" required>
          </div>
          <div id="agregarStockError" class="alert alert-danger d-none"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Agregar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Quitar Stock -->
<div class="modal fade" id="quitarStockModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Quitar Stock</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="formQuitarStock" method="post">
        {% csrf_token %}
        <input type="hidden" name="operation" value="quitar_stock">
        <input type="hidden" name="producto_id" id="quitarStockProductoId">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Producto</label>
            <input type="text" class="form-control" id="quitarStockProductoNombre" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Stock Actual</label>
            <input type="text" class="form-control" id="quitarStockActual" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Cantidad a Quitar</label>
            <input type="number" step="1" min="1" class="form-control" name="cantidad" required>
          </div>
          <div id="quitarStockError" class="alert alert-danger d-none"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Quitar</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<!-- SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<!-- Animate.css -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(document).ready(function() {
    // Configuración AJAX global
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", $('[name=csrfmiddlewaretoken]').val());
            }
        }
    });

    // Función para verificar si un producto ya existe
    function productoExiste(nombre) {
        let existe = false;
        $('#productList .card-title').each(function() {
            if ($(this).text().trim().toLowerCase() === nombre.trim().toLowerCase()) {
                existe = true;
                return false; // Salir del bucle
            }
        });
        return existe;
    }

    // Validación en tiempo real del nombre del producto
    $('#agregarProductoModal input[name="nombre"]').on('input', function() {
        const nombre = $(this).val();
        const feedback = $('#nombreProductoFeedback');
        const btnSubmit = $('#formAgregarProducto button[type="submit"]');
        
        if (productoExiste(nombre)) {
            $(this).addClass('is-invalid');
            feedback.text('¡Este producto ya existe!').removeClass('d-none');
            btnSubmit.prop('disabled', true);
        } else {
            $(this).removeClass('is-invalid');
            feedback.addClass('d-none');
            btnSubmit.prop('disabled', false);
        }
    });

    // Inicializar todos los componentes
    function initComponents() {
        // Tooltips
        $('[data-bs-toggle="tooltip"]').tooltip();
        
        // Evento de búsqueda
        $('#searchInput').off('input').on('input', function() {
            const query = $(this).val().trim().toLowerCase();
            $('#productList [data-nombre]').each(function() {
                $(this).toggle($(this).data('nombre').includes(query));
            });
        });
        
        // Asignar eventos a los botones
        assignButtonEvents();
    }

    // Asignar eventos a los botones
    function assignButtonEvents() {
        // Eliminar producto
        $('.btn-eliminar').off('click').on('click', function() {
            const productoId = $(this).data('id');
            const card = $(this).closest('.col-xl-3');
            const productoNombre = card.find('.card-title').text();
            
            Swal.fire({
                title: '¿Eliminar producto?',
                html: `Estás a punto de eliminar el producto <strong>${productoNombre}</strong>.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: window.location.href,
                        method: 'POST',
                        data: {
                            operation: 'delete',
                            id: productoId
                        },
                        success: function(response) {
                            if (response.success) {
                                card.fadeOut(300, function() { $(this).remove(); });
                                showSuccess('Producto eliminado correctamente');
                            }
                        },
                        error: showError
                    });
                }
            });
        });

        // Agregar stock
        $('.btn-agregar').off('click').on('click', function() {
            const productoId = $(this).data('id');
            const productoNombre = $(this).data('nombre');
            const stockActual = $(this).closest('.card-body').find('.stock-value').text();
            
            $('#agregarStockProductoId').val(productoId);
            $('#agregarStockProductoNombre').val(productoNombre);
            $('#agregarStockActual').val(stockActual);
            $('#agregarStockModal').modal('show');
        });

        // Quitar stock
        $('.btn-quitar').off('click').on('click', function() {
            const productoId = $(this).data('id');
            const productoNombre = $(this).data('nombre');
            const stockActual = $(this).closest('.card-body').find('.stock-value').text();
            
            $('#quitarStockProductoId').val(productoId);
            $('#quitarStockProductoNombre').val(productoNombre);
            $('#quitarStockActual').val(stockActual);
            $('#quitarStockModal').modal('show');
        });

        // Registrar merma
        $('.btn-merma').off('click').on('click', function() {
            const productoId = $(this).data('id');
            const productoNombre = $(this).data('nombre');
            const stockActual = $(this).closest('.card-body').find('.stock-value').text();
            
            $('#mermaProductoId').val(productoId);
            $('#mermaProductoNombre').val(productoNombre);
            $('#mermaStockActual').val(stockActual);
            $('#mermaModal').modal('show');
        });
    }

    // Función para actualizar la lista de productos
    function updateProductList() {
        $.ajax({
            url: window.location.href,
            method: 'GET',
            success: function(data) {
                // Parsear el HTML recibido
                const $response = $('<div>').html(data);
                const newContent = $response.find('#productList').html();
                
                // Reemplazar el contenido con animación
                $('#productList').fadeOut(200, function() {
                    $(this).html(newContent).fadeIn(200, function() {
                        initComponents();
                    });
                });
            },
            error: function() {
                showError('Error al actualizar la lista');
            }
        });
    }

    // Formulario para agregar producto
    $('#formAgregarProducto').submit(function(e) {
        e.preventDefault();
        const form = $(this);
        const nombreProducto = form.find('input[name="nombre"]').val();
        const errorDiv = $('#formAgregarProductoError');
        errorDiv.addClass('d-none').text('');
        
        // Validación adicional por si acaso
        if (productoExiste(nombreProducto)) {
            errorDiv.text('Este producto ya existe en el inventario').removeClass('d-none');
            return false;
        }
        
        $.ajax({
            url: window.location.href,
            method: 'POST',
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    $('#agregarProductoModal').modal('hide');
                    form[0].reset();
                    
                    showSuccess('Producto agregado correctamente').then(function() {
                        updateProductList();
                    });
                }
            },
            error: function(xhr) {
                if (xhr.status === 400 && xhr.responseJSON.error === 'El producto ya existe') {
                    errorDiv.text('Este producto ya existe en el inventario').removeClass('d-none');
                } else {
                    errorDiv.text(
                        xhr.responseJSON?.error || 'Error al agregar el producto'
                    ).removeClass('d-none');
                }
            }
        });
    });

    // Formulario para agregar stock
    $('#formAgregarStock').submit(function(e) {
        e.preventDefault();
        const form = $(this);
        const cantidad = parseInt(form.find('input[name="cantidad"]').val());
        const errorDiv = $('#agregarStockError');
        
        errorDiv.addClass('d-none').text('');
        
        if (isNaN(cantidad) || cantidad <= 0) {
            errorDiv.text('Ingrese una cantidad válida').removeClass('d-none');
            return;
        }
        
        $.ajax({
            url: window.location.href,
            method: 'POST',
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    $('#agregarStockModal').modal('hide');
                    form[0].reset();
                    
                    // Actualizar el stock visualmente
                    $(`.btn-agregar[data-id="${response.producto_id}"]`)
                        .closest('.card-body')
                        .find('.stock-value')
                        .text(response.nuevo_stock);
                    
                    showSuccess(`Stock actualizado: ${response.nuevo_stock}`);
                }
            },
            error: function(xhr) {
                errorDiv.text(
                    xhr.responseJSON?.error?.cantidad || 'Error al actualizar stock'
                ).removeClass('d-none');
            }
        });
    });

    // Formulario para quitar stock
    $('#formQuitarStock').submit(function(e) {
        e.preventDefault();
        const form = $(this);
        const cantidad = parseInt(form.find('input[name="cantidad"]').val());
        const stockActual = parseInt($('#quitarStockActual').val());
        const errorDiv = $('#quitarStockError');
        
        errorDiv.addClass('d-none').text('');
        
        if (isNaN(cantidad) || cantidad <= 0) {
            errorDiv.text('Ingrese una cantidad válida').removeClass('d-none');
            return;
        }
        if (cantidad > stockActual) {
            errorDiv.text(`No puede quitar más de ${stockActual}`).removeClass('d-none');
            return;
        }
        
        $.ajax({
            url: window.location.href,
            method: 'POST',
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    $('#quitarStockModal').modal('hide');
                    form[0].reset();
                    
                    // Actualizar el stock visualmente
                    $(`.btn-quitar[data-id="${response.producto_id}"]`)
                        .closest('.card-body')
                        .find('.stock-value')
                        .text(response.nuevo_stock);
                    
                    showSuccess(`Stock actualizado: ${response.nuevo_stock}`);
                }
            },
            error: function(xhr) {
                errorDiv.text(
                    xhr.responseJSON?.error?.cantidad || 'Error al actualizar stock'
                ).removeClass('d-none');
            }
        });
    });

    // Formulario para registrar merma
    $('#formMerma').submit(function(e) {
        e.preventDefault();
        const form = $(this);
        const cantidad = parseInt(form.find('input[name="cantidad"]').val());
        const stockActual = parseInt($('#mermaStockActual').val());
        const errorDiv = $('#mermaError');
        
        errorDiv.addClass('d-none').text('');
        
        if (isNaN(cantidad) || cantidad <= 0) {
            errorDiv.text('Ingrese una cantidad válida').removeClass('d-none');
            return;
        }
        if (cantidad > stockActual) {
            errorDiv.text(`No puede registrar más de ${stockActual}`).removeClass('d-none');
            return;
        }
        
        $.ajax({
            url: window.location.href,
            method: 'POST',
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    $('#mermaModal').modal('hide');
                    form[0].reset();
                    
                    // Actualizar el stock visualmente
                    $(`.btn-merma[data-id="${response.producto_id}"]`)
                        .closest('.card-body')
                        .find('.stock-value')
                        .text(response.nuevo_stock);
                    
                    showSuccess(`Merma registrada. Nuevo stock: ${response.nuevo_stock}`);
                }
            },
            error: function(xhr) {
                errorDiv.text(
                    xhr.responseJSON?.error?.cantidad || 'Error al registrar merma'
                ).removeClass('d-none');
            }
        });
    });

    // Funciones auxiliares
    function showSuccess(message) {
        return Swal.fire({
            title: '¡Éxito!',
            text: message,
            icon: 'success',
            timer: 2000,
            showConfirmButton: false,
            toast: true,
            position: 'top-end'
        });
    }

    function showError(message) {
        Swal.fire({
            title: 'Error',
            text: message || 'Ocurrió un error',
            icon: 'error'
        });
    }

    // Inicializar modales
    $('.modal').on('hidden.bs.modal', function() {
        $(this).find('form')[0].reset();
        $(this).find('.alert').addClass('d-none');
    });

    // Inicializar todo al cargar
    initComponents();
});
</script>
{% endblock %}