{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="logo-fullscreen mb-5">
    <img src="{% static 'images/logo.jpg' %}" alt="Logo de la empresa" class="img-fluid w-100" style="height: auto;">
</div>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-5">Gestión de Inventario</h1>
            <p class="lead">Bienvenido, {{ user.username }}</p>
        </div>
        <div class="col-auto d-flex align-items-center">
    <!-- Botón Nuevo Producto -->
    <button class="btn btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#agregarProductoModal">
        <i class="bi bi-plus-circle"></i> Nuevo Producto
    </button>
    <!-- Botón Mermas -->
    <a href="{% url 'inventario:mermas_publico' %}" class="btn btn-primary ms-2">
        <i class="bi bi-clipboard-data"></i> Registros de Mermas
    </a>
</div>

    <div id="mensajeExito" class="alert alert-success alert-dismissible fade show d-none" role="alert">
        <span id="mensajeTexto"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Barra de búsqueda movida a la izquierda -->
    <div class="row mb-3">
        <div class="col">
            <div class="input-group" style="max-width: 300px;">
                <input type="text" id="searchInput" class="form-control" placeholder="Buscar productos..." aria-label="Buscar productos">
                <button class="btn btn-outline-secondary" type="button" id="searchButton">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="row" id="productList">
        {% for producto in productos %}
        <div class="col-xl-3 col-lg-4 col-md-6 mb-4" data-nombre="{{ producto.nombre|lower }}">
            <div class="card h-100 shadow-sm position-relative">
                <button class="btn btn-sm btn-danger btn-eliminar position-absolute top-0 end-0 m-2 rounded-circle" 
                        data-id="{{ producto.id }}"
                        style="width: 30px; height: 30px; padding: 0;">
                    <i class="bi bi-trash"></i>
                </button>
                
                <div class="card-body">
                    <h5 class="card-title">{{ producto.nombre }}</h5>
                    <p class="card-text mb-3">
                        <strong>Stock:</strong> <span class="stock-value">{{ producto.cantidad }}</span> {{ producto.get_unidad_display }}
                    </p>
                    
                    <div class="d-flex justify-content-between gap-2">
                        <!-- Botón Agregar -->
                        <button class="btn btn-sm btn-success btn-agregar flex-grow-1"
                                data-id="{{ producto.id }}"
                                data-nombre="{{ producto.nombre }}"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Agregar stock">
                            <i class="bi bi-plus-circle"></i> <span class="d-none d-md-inline">Agregar</span>
                        </button>
                        
                        <!-- Botón Quitar -->
                        <button class="btn btn-sm btn-danger btn-quitar flex-grow-1"
                                data-id="{{ producto.id }}"
                                data-nombre="{{ producto.nombre }}"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Quitar stock">
                            <i class="bi bi-dash-circle"></i> <span class="d-none d-md-inline">Quitar</span>
                        </button>
                        
                        <!-- Botón Merma -->
                        <button class="btn btn-sm btn-warning btn-merma flex-grow-1"
                                data-id="{{ producto.id }}"
                                data-nombre="{{ producto.nombre }}"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Registrar merma">
                            <i class="bi bi-clipboard-minus"></i> <span class="d-none d-md-inline">Merma</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info">No hay productos registrados</div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal Agregar Producto -->
<div class="modal fade" id="agregarProductoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Agregar Nuevo Producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="formAgregarProducto" method="post" novalidate>
        {% csrf_token %}
        <input type="hidden" name="operation" value="create">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nombre del Producto</label>
            <input type="text" class="form-control" name="nombre" required>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Cantidad</label>
              <input type="number" step="1" min="0" class="form-control" name="cantidad" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Unidad</label>
              <select class="form-select" name="unidad" required>
                {% for value, label in unidades.items %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div id="formAgregarProductoError" class="alert alert-danger d-none"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Producto</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Merma -->
<div class="modal fade" id="mermaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title">Registrar Merma</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="formMerma" method="post">
        {% csrf_token %}
        <input type="hidden" name="operation" value="merma">
        <input type="hidden" name="producto_id" id="mermaProductoId">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Producto</label>
            <input type="text" class="form-control" id="mermaProductoNombre" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Stock Actual</label>
            <input type="text" class="form-control" id="mermaStockActual" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Cantidad a Descontar</label>
            <input type="number" step="1" min="1" class="form-control" name="cantidad" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Motivo</label>
            <textarea class="form-control" name="motivo" rows="3" required></textarea>
          </div>
          <div id="mermaError" class="alert alert-danger d-none"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-warning">Registrar Merma</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Agregar Stock -->
<div class="modal fade" id="agregarStockModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Agregar Stock</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="formAgregarStock" method="post">
        {% csrf_token %}
        <input type="hidden" name="operation" value="agregar_stock">
        <input type="hidden" name="producto_id" id="agregarStockProductoId">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Producto</label>
            <input type="text" class="form-control" id="agregarStockProductoNombre" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Stock Actual</label>
            <input type="text" class="form-control" id="agregarStockActual" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Cantidad a Agregar</label>
            <input type="number" step="1" min="1" class="form-control" name="cantidad" required>
          </div>
          <div id="agregarStockError" class="alert alert-danger d-none"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Agregar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Quitar Stock -->
<div class="modal fade" id="quitarStockModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Quitar Stock</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="formQuitarStock" method="post">
        {% csrf_token %}
        <input type="hidden" name="operation" value="quitar_stock">
        <input type="hidden" name="producto_id" id="quitarStockProductoId">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Producto</label>
            <input type="text" class="form-control" id="quitarStockProductoNombre" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Stock Actual</label>
            <input type="text" class="form-control" id="quitarStockActual" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Cantidad a Quitar</label>
            <input type="number" step="1" min="1" class="form-control" name="cantidad" required>
          </div>
          <div id="quitarStockError" class="alert alert-danger d-none"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Quitar</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                const token = $('[name=csrfmiddlewaretoken]').val();
                xhr.setRequestHeader("X-CSRFToken", token);
            }
        }
    });

    $('[data-bs-toggle="tooltip"]').tooltip();

    $('#agregarProductoModal, #agregarStockModal, #quitarStockModal, #mermaModal').on('hidden.bs.modal', function () {
        $(this).find('.btn-close').blur();
    });

    $('#searchInput').on('input', function() {
        const query = $(this).val().trim().toLowerCase();
        const productCards = $('#productList .col-xl-3');

        if (query.length > 0) {
            productCards.each(function() {
                const productName = $(this).data('nombre');
                if (productName.includes(query)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        } else {
            productCards.show();
        }
    });

    $('.btn-agregar').click(function() {
        const productoId = $(this).data('id');
        const productoNombre = $(this).data('nombre');
        const stockActual = $(this).closest('.card-body').find('.stock-value').text();
        
        $('#agregarStockProductoId').val(productoId);
        $('#agregarStockProductoNombre').val(productoNombre);
        $('#agregarStockActual').val(stockActual);
        $('#agregarStockError').addClass('d-none').text('');
        $('#agregarStockModal').modal('show');
    });

    $('.btn-quitar').click(function() {
        const productoId = $(this).data('id');
        const productoNombre = $(this).data('nombre');
        const stockActual = $(this).closest('.card-body').find('.stock-value').text();
        
        $('#quitarStockProductoId').val(productoId);
        $('#quitarStockProductoNombre').val(productoNombre);
        $('#quitarStockActual').val(stockActual);
        $('#quitarStockError').addClass('d-none').text('');
        $('#quitarStockModal').modal('show');
    });

    $('.btn-merma').click(function() {
        const productoId = $(this).data('id');
        const productoNombre = $(this).data('nombre');
        const stockActual = $(this).closest('.card-body').find('.stock-value').text();
        
        $('#mermaProductoId').val(productoId);
        $('#mermaProductoNombre').val(productoNombre);
        $('#mermaStockActual').val(stockActual);
        $('#mermaError').addClass('d-none').text('');
        $('#mermaModal').modal('show');
    });

    $('.btn-eliminar').click(function() {
        const productoId = $(this).data('id');
        if (confirm('¿Estás seguro de que deseas eliminar este producto?')) {
            $.ajax({
                url: window.location.href,
                method: 'POST',
                data: {
                    operation: 'delete',
                    id: productoId,
                    csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.success) {
                        $(`[data-id="${productoId}"]`).closest('.col-xl-3').remove();
                        $('#mensajeTexto').text('Producto eliminado correctamente');
                        $('#mensajeExito').removeClass('d-none').delay(3000).fadeOut();
                    }
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON && xhr.responseJSON.error 
                        ? xhr.responseJSON.error 
                        : 'Error al eliminar el producto';
                    alert(errorMsg);
                }
            });
        }
    });

    $('#formAgregarProducto').submit(function(e) {
        e.preventDefault();
        const form = $(this);
        const errorDiv = $('#formAgregarProductoError');
        errorDiv.addClass('d-none').text('');
        
        $.ajax({
            url: window.location.href,
            method: 'POST',
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    $('#agregarProductoModal').modal('hide');
                    form[0].reset();
                    $('#mensajeTexto').text(`Producto ${response.producto.nombre} agregado correctamente`);
                    $('#mensajeExito').removeClass('d-none').delay(3000).fadeOut();
                    location.reload();
                }
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON && xhr.responseJSON.error 
                    ? JSON.stringify(xhr.responseJSON.error) 
                    : 'Error al agregar el producto';
                errorDiv.text(errorMsg).removeClass('d-none');
            }
        });
    });

    $('#formAgregarStock').submit(function(e) {
        e.preventDefault();
        const form = $(this);
        const cantidad = parseInt(form.find('input[name="cantidad"]').val());
        const errorDiv = $('#agregarStockError');
        
        errorDiv.addClass('d-none').text('');
        
        if (isNaN(cantidad) || cantidad <= 0) {
            errorDiv.text('Por favor, ingrese una cantidad válida (número entero mayor a 0).').removeClass('d-none');
            return;
        }
        
        $.ajax({
            url: window.location.href,
            method: 'POST',
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    $('#agregarStockModal').modal('hide');
                    form[0].reset();
                    
                    const stockElement = $(`.btn-agregar[data-id="${response.producto_id}"]`).closest('.card-body').find('.stock-value');
                    if (stockElement.length) {
                        stockElement.text(response.nuevo_stock);
                    }
                    
                    $('#mensajeTexto').text(`Stock actualizado: ${response.producto_nombre} - Nuevo stock: ${response.nuevo_stock}`);
                    $('#mensajeExito').removeClass('d-none').delay(3000).fadeOut();
                }
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON && xhr.responseJSON.error && xhr.responseJSON.error.cantidad 
                    ? xhr.responseJSON.error.cantidad 
                    : 'Error al actualizar el stock';
                errorDiv.text(errorMsg).removeClass('d-none');
            }
        });
    });

    $('#formQuitarStock').submit(function(e) {
        e.preventDefault();
        const form = $(this);
        const cantidad = parseInt(form.find('input[name="cantidad"]').val());
        const stockActual = parseInt($('#quitarStockActual').val());
        const errorDiv = $('#quitarStockError');
        
        errorDiv.addClass('d-none').text('');
        
        if (isNaN(cantidad) || cantidad <= 0) {
            errorDiv.text('Por favor, ingrese una cantidad válida (número entero mayor a 0).').removeClass('d-none');
            return;
        }
        if (cantidad > stockActual) {
            errorDiv.text(`No puedes quitar ${cantidad} porque el stock actual es solo ${stockActual}.`).removeClass('d-none');
            return;
        }
        
        $.ajax({
            url: window.location.href,
            method: 'POST',
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    $('#quitarStockModal').modal('hide');
                    form[0].reset();
                    
                    const stockElement = $(`.btn-quitar[data-id="${response.producto_id}"]`).closest('.card-body').find('.stock-value');
                    if (stockElement.length) {
                        stockElement.text(response.nuevo_stock);
                    }
                    
                    $('#mensajeTexto').text(`Stock actualizado: ${response.producto_nombre} - Nuevo stock: ${response.nuevo_stock}`);
                    $('#mensajeExito').removeClass('d-none').delay(3000).fadeOut();
                }
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON && xhr.responseJSON.error && xhr.responseJSON.error.cantidad 
                    ? xhr.responseJSON.error.cantidad 
                    : 'Error al actualizar el stock';
                errorDiv.text(errorMsg).removeClass('d-none');
            }
        });
    });

    $('#formMerma').submit(function(e) {
        e.preventDefault();
        const form = $(this);
        const cantidad = parseInt(form.find('input[name="cantidad"]').val());
        const stockActual = parseInt($('#mermaStockActual').val());
        const errorDiv = $('#mermaError');
        
        errorDiv.addClass('d-none').text('');
        
        if (isNaN(cantidad) || cantidad <= 0) {
            errorDiv.text('Por favor, ingrese una cantidad válida (número entero mayor a 0).').removeClass('d-none');
            return;
        }
        if (cantidad > stockActual) {
            errorDiv.text(`No puedes registrar una merma de ${cantidad} porque el stock actual es solo ${stockActual}.`).removeClass('d-none');
            return;
        }
        
        $.ajax({
            url: window.location.href,
            method: 'POST',
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    $('#mermaModal').modal('hide');
                    form[0].reset();
                    
                    const stockElement = $(`.btn-merma[data-id="${response.producto_id}"]`).closest('.card-body').find('.stock-value');
                    if (stockElement.length) {
                        stockElement.text(response.nuevo_stock);
                    }
                    
                    $('#mensajeTexto').text(`Merma registrada: ${response.producto_nombre} - Nuevo stock: ${response.nuevo_stock}`);
                    $('#mensajeExito').removeClass('d-none').delay(3000).fadeOut();
                }
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON && xhr.responseJSON.error && xhr.responseJSON.error.cantidad 
                    ? xhr.responseJSON.error.cantidad 
                    : 'Error al registrar merma';
                errorDiv.text(errorMsg).removeClass('d-none');
            }
        });
    });
});
</script>
{% endblock %}